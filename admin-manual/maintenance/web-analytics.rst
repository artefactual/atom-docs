.. _maintenance-web-analytics:

=============
Web analytics
=============

According to `Wikipedia <https://en.wikipedia.org/wiki/Web_analytics>`__, web
analytics is "*the measurement, collection, analysis and reporting of internet
data for purposes of understanding and optimizing web usage.*"

There are two main technological approaches to collecting the data: logfile
analysis, which reads the logfiles in which the web server records all its
transactions; and page tagging, which uses JavaScript on each page to notify a
third-party server when a page is rendered by a web browser.

.. TIP::

   If your analytics tracker is not working, try turning debugging on and off
   again via ``index.php``. The analytics code should appear in 'View Source'.

   See: :ref:`debug-mode`

**Jump to:**

* :ref:`logfile-analysis`
* :ref:`page-tagging-tools`

  * :ref:`google-analytics`
  * :ref:`google-tag-manager`

.. SEEALSO::

   * :ref:`maintenance-webserver`

.. _logfile-analysis:

Logfile analysis tools
======================

These types of tools require access to the log files generated by the web server.

* AWStats: http://awstats.sourceforge.net/
* Webalizer: http://www.webalizer.org/

.. _page-tagging-tools:

Page tagging tools
==================

The tools found under this section require a system administrator or developer
to insert a JavaScript code snippet into the relevant page in AtoM where you'd
like to gather analytic data. Probably the best known open source solution is
`Piwiki <http://piwik.org/>`_.

You should be able to configure any solution in AtoM by editing the
corresponding 
`PHP templates <https://github.com/artefactual/atom/tree/HEAD/apps/qubit/templates>`_.

AtoM also includes built-in integration with `Google Analytics`_, described
further below. By studying the way that the tracking snippets are incorporated 
into the PHP templates linked above, you should be able to make modifications
as needed based on your chosen solution to implement something similar.  

**Jump to:**

* :ref:`google-analytics`
* :ref:`google-tag-manager`

:ref:`Back to top <maintenance-web-analytics>`

.. _google-analytics:

Google Analytics
----------------

`Google Analytics`_ is a web analytics service offered by Google that tracks and
reports website traffic and activity, such as session duration, pages viewed
per session, bounce rates of individuals using the site, and more. 

You can configure `Google Analytics`_ in AtoM by adding your tracking
ID to the ``config/app.yml`` configuration file:

.. code-block:: yaml

     google_analytics_api_key: G-XXXXXXXXXX

Replace ``G-XXXXXXXXXX`` with your tracking ID. Once you are done, remember to
:ref:`clear the cache <maintenance-clear-cache>` and 
:ref:`restart PHP-FPM <troubleshooting-restart-php-fpm>`.

.. SEEALSO::

   * :ref:`customization-config-files`

.. _google-analytics-repo-pageviews:

Google Analytics for tracking institutional pageviews
+++++++++++++++++++++++++++++++++++++++++++++++++++++

It's also possible to track pageviews for individual institutions who are
sharing a multi-repository AtoM instance by adding a custom dimension to the
tracking ID. Adding this dimension will set the authorized form of name from
the source culture of the repository as the dimension value (e.g. for a
repository where the source culture is English but translations into other
languages are present, Analytics will use the English form of the authorized
form of name).

* Description pages (all templates) use the *repository* value (direct or inherited)
* Actor pages use the *maintaining repository* value
* Repository pages use the repository's *authorized form of name* value

.. SEEALSO::
   
   * :ref:`archival-institutions`
   * :ref:`link-archival-institution`
   * :ref:`link-repo-actor`

Follow the instructions provided in Google's Analytics Help pages to
`Set up custom dimension`_. When you reach step 6, *Select the scope*, choose
**Hit** as the scope and set it to *active*. Once you have completed all the
steps, the custom dimension will be displayed in a table. The index number is
displayed in the column **Index**.

In the ``config/app.yml`` configuration file, set the newly-created dimension
index number below the API key and make sure that the setting is uncommented.

.. code-block:: yaml

     google_analytics_api_key: G-XXXXXXXXXX
     google_analytics_institutions_dimension_index: 1

Once you are done, remember to
:ref:`clear the cache <maintenance-clear-cache>` and 
:ref:`restart PHP-FPM <troubleshooting-restart-php-fpm>`.

.. SEEALSO::

   * :ref:`customization-config-files`

Viewing Google Analytics institutional pageview data
++++++++++++++++++++++++++++++++++++++++++++++++++++

There are several ways to visualize analytics data in the Google Analytics
dashboard. You can view institution names in the page views table:

#. In the Google Analytics dashboard left sidebar, select **Behaviour**.
#. Under **Site Content**, select **All pages**.
#. In the main body of the page, below the graph showing page hits, open the
   **Secondary dimension** dropdown and select **Custom Dimensions**, then your
   dimension.
#. A new column should appear in the table below, with the name of the custom
   dimension as the column header. Clicking on the column header will sort the
   table alphabetically by institution.
#. You can export this data by clicking the **Export** button in the top right.

   .. image:: images/google-analytics-custom-dimension.*
      :align: center
      :width: 90%
      :alt: The Google Analytics page behaviour screen, with the secondary dimension highlighted

It is also possible to create a custom report that displays the total number of
pageviews for each institution:

#. In the Google Analytics dashboard left sidebar, select **Customization**,
   followed by **Custom Reports**.
#. Select **New custom report**.
#. Give the report a title and following parameters:

   * Name: The default name is fine; if you want to add more tabs to the resulting
     output, you can change it to a more specific name.
   * Type: Select **Flat Table**
   * Dimensions: Click on **+ add dimension** and select Page (under Behaviour);
     repeat and select Institution (under Custom Dimension)
   * Metrics: Click on **+ add metric** and select Pageviews (under Users)

#. Click Save. The report will be displayed and can be exported by clicking the
   **Export** button in the top right.
#. You can save this report for future review by clicking on the **Save** button
   in the top right.

:ref:`Back to top <maintenance-web-analytics>`

.. _google-tag-manager:

Google Tag Manager
------------------

Like `Google Analytics`_, `Google Tag Manager`_ is a web based analytics
service offered by Google, with a somewhat different focus. Tag Manager is a
tag management system (TMS) that allows you to quickly and easily manage
tracking and measurement codes and marketing tags (collectively known as
"tags") on a website or mobile application, without having to modify the code
directly.

These can be used in AtoM to collect end-user analytics in a more granular way
than Google Analytics allows on its own - for example, seeing how often a
:term:`finding aid` is downloaded, or how often a :term:`clipboard` is saved. 

The following section will walk you through set-up and configuration of 
Tag Manager for use in AtoM, and we'll use tracking finding aid downloads as
an example implementation. 

**Requirements**

You'll need to have a `Google Analytics`_ account, and your tracking ID, 
configured with a `web property`_, to be able to visualize Tag Manager reports. 
You'll also need to set up a 
`Google Tag Manager account <https://support.google.com/tagmanager/answer/6103696?hl=en&ref_topic=3441530>`__, to configure your
containers and tags.

Let's begin!

* :ref:`tag-manager-web-property-config`
* :ref:`tag-manager-container-setup`
* :ref:`tag-manager-variables`
* :ref:`tag-manager-triggers`
* :ref:`tag-manager-findaid-example`
* :ref:`tag-manager-preview`
* :ref:`tag-manager-publish-report`

.. _tag-manager-web-property-config:

Google Analytics web property setup
+++++++++++++++++++++++++++++++++++

1. If you haven't already, log in to https://analytics.google.com with a Google 
   account and click the "Create Account" button.

.. image:: images/analytics-create-account.*
   :align: center
   :width: 90%
   :alt: Creating an account in Google Analytics

2. In the "What do you want to measure?" section, select **Web**.

.. image:: images/analytics-create-account-measure.*
   :align: center
   :width: 90%
   :alt: Selecting Web while creating a Google Analytics account

3. Fill out the Property setup section and click the "Create" button. 

.. image:: images/analytics-create-account-property.*
   :align: center
   :width: 90%
   :alt: Configuring the Property section while creating an account in Google Analytics

4. Accept the service agreement that pops up. You'll be redirected to the 
   Tracking Code section of your new web property. Copy down the Tracking ID 
   shown on this screen - you'll need this to set up your Google Tag Manager 
   variables.

.. image:: images/analytics-property-tracking-code.*
   :align: center
   :width: 90%
   :alt: The Tracking ID shown in Analytics after accepting the service agreement

.. _tag-manager-container-setup:

Google Tag Manager container set up
+++++++++++++++++++++++++++++++++++

1. Log in to https://tagmanager.google.com/ with a Google account and click the 
   "Create Account" button.

   .. image:: images/gtm-create-account.*
      :align: center
      :width: 90%
      :alt: Creating an account in Google Tag Manager

   The account will be created with a single Google Tag Manager container and
   you specify its name and type in the Container Setup area. You can specify
   it as a Web container for the AtoM functionality.


2. Click create. You'll be shown a service agreement, and when you click Yes
   to agree to its terms, you'll be redirected to the container dashboard,
   which will show the code snippets for the first time. AtoM will produce
   these automatically from the container ID so you don't need to copy them,
   and can close the dialog.

.. image:: images/gtm-snippets.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager code snippets

3. The ID for your new container will be displayed in the dashboard:

   .. image:: images/gtm-dashboard-container-id.*
      :align: center
      :width: 90%
      :alt: Google Tag Manager dashboard, with the container ID highlighted in 
            the top right corner

   You'll need to copy this ID into AtoM's ``config/app.yml`` configuration 
   file. An example: 

   .. code-block:: yaml

      google_tag_manager_container_id: GTM-AC4M1L4

.. TIP:: 

   For more information on working with AtoM's configuration files, see: 

   * :ref:`customization-config-files`

   Don't forget to clear the application cache and restart PHP-FPM after
   modifying this file! See: 

   * :ref:`maintenance-clear-cache`
   * :ref:`troubleshooting-restart-php-fpm`

4. Once the tracking code is in place and PHP-FPM has been restarted, the
   tracking code snippets will be included in every page and you can start
   setting up tags to track events in your pages and getting reports in
   Google Analytics.

.. _tag-manager-variables:

Tag Manager Variables
+++++++++++++++++++++

In the following example we're going to track Click events (buttons, links, 
etc). First we need to enable the built-in "Clicks" variables, and make a few
other configuration changes. 

1. Click "Variables" in the left sidebar and then the "Configure" button in the 
   Built-in Variables section.

.. image:: images/gtm-variables.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Variables configuration page

2. Enable all the Clicks variables:

.. image:: images/gtm-variables-enable.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Variables configuration page

3. We can also create a variable to store the Tracking ID of the 
   `Google Analytics`_ web property we set up in the section 
   :ref:`above <tag-manager-web-property-config>`, so we can reuse it in 
   multiple tags. 

   To do so, click "Variables" in the left sidebar and then the "New" button in 
   the *User-Defined Variables* section.

.. image:: images/gtm-variables.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Variables configuration page

4. In the **Variable Configuration** section, click the Lego block icon or the
   pencil icon to get started. In the resulting configuration page, select the
   Google Analytics Settings type, and set the Tracking ID of your Google
   Analytics web property. At the top of the page, we'll also name the new
   variable "Tracking ID" so we can identify it when setting tags. When this
   is complete, click the "Save" button.

.. image:: images/gtm-variables-tracking-id.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Variables configuration page

.. _tag-manager-triggers:

Tag Manager Triggers
++++++++++++++++++++

Triggers listen to events on specific page elements and make tags react when
the event is detected. We're going to create a trigger to listen to click
events on the Download button of the :term:`Finding aids <finding aid>` section 
of the right-hand :term:`context menu` of an :term:`archival description`. Note 
that this button is just an HTML link element styled to look like a button. 
Let's set up a trigger for this event. 

.. SEEALSO::

   :ref:`print-finding-aids`

1. Click "Triggers" in the left sidebar, and the "New" button in the Triggers
   section.

.. image:: images/gtm-triggers.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Triggers page

2. In the Trigger Configuration section click the circled button or the pencil
   icon and choose the "Just Links" trigger type under the Click category.

.. image:: images/gtm-triggers-just-links.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Triggers page - choosing the trigger type

3. Under "This trigger fires on," select "Some Link Clicks," which allows you
   to define selectors to identify the specific HTML elements you want to
   track. This will depend on the markup of the page and how specific you want
   to be. A selector like ``#action-items a.btn`` (all links that look like a
   button on the right sidebar) might be good enough or ``#action-items
   a.btn[href$=".pdf"]`` (all links that look like a button on the right
   sidebar and where the ``href`` URI ends in ``.pdf``) might be way more
   specific. Name the trigger "Download button" and then click the Save button
   at the top of the screen.

.. image:: images/gtm-triggers-download-button.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Triggers configuration panel

.. _tag-manager-findaid-example:

Tag example: tracking finding aid downloads
+++++++++++++++++++++++++++++++++++++++++++

Now that we've configured our Variables and Triggers, in the following example
we're going to track how many times users click the :term:`finding aid` Download
button in the right :term:`context menu` of an :term:`archival description`.
We are going to generate a report that groups all these events in the single
category of "Finding Aids," and which shows the URL of their related archival
description.

1. Click "Tags" on the left sidebar and the New button in the Tags section.

.. image:: images/gtm-tags.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Tags landing page

2. In the Tag Configuration section, click the tag button or the pencil icon
   and choose the "Google Analytics: Universal Analytics" type. For Track Type
   select "Event" and for the Google Analytics Setting, select your Tracking
   ID variable.

.. image:: images/gtm-tags-config.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Tags configuration panel

3. The Category, Action and Label tracking parameters are arbitrary values
   that become dimensions in the `Google Analytics`_ event reports so you can
   adjust them conveniently. For example, we're going to use the URL of the
   archival description as the Event label, so click the lego block button
   next to the field and select the "Click URL" variable.

.. image:: images/gtm-tags-event.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Tags configuration panel - setting the Event label

4. In the Triggering section click the circled button or the pencil and choose
   the Download button we configured in the 
   :ref:`previous section <tag-manager-triggers>`.

.. image:: images/gtm-tags-choose-trigger.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Tags configuration panel - choosing the trigger

5. Finally, name your tag "Finding Aids Download" and click the Save button at
   the top of the screen.

.. image:: images/gtm-tags-finding-aids-download.*
   :align: center
   :width: 90%
   :alt: Google Tag Manager Tags configuration panel - choosing the trigger

We're almost set! Let's preview our work and make sure everything is working
as expected.

.. _tag-manager-preview:

Previewing your Google Tag functionality
++++++++++++++++++++++++++++++++++++++++

Before publishing your new tag you can preview its functionality by clicking
the Preview button in the container dashboard. Once you're in preview mode you
can open a new tab in the same browser and visit your site.

You'll see a Tag Manager pane at the bottom of your page.

.. image:: images/gtm-preview.*
   :align: center
   :width: 90%
   :alt: Previewing your AtoM site via Google Tag Manager

If you click the :term:`finding aid` download button of an 
:term:`archival description`, the PDF will be open in a new tab and you'll see a 
new Click event in the Summary sidebar showing that the tag was successfully 
fired.

.. image:: images/gtm-preview-tag-fired.*
   :align: center
   :width: 90%
   :alt: Previewing a finding aid Click event on your AtoM site via Google 
         Tag Manager

.. _tag-manager-publish-report:

Publishing your tag and getting an Analytics event report
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++

After you check that the tag works you can publish your workspace by clicking
the "Submit" button in the `Google Tag Manager`_ Container dashboard. Set a name 
and description for the version changes and click the "Publish" button.

.. image:: images/gtm-submit.*
   :align: center
   :width: 90%
   :alt: Submitting and publishing your tag in Google Tag Manager

Now you can visit your web property in Google Analytics. You can either check 
the **Realtime > Events** report:

.. image:: images/analytics-realtime.*
   :align: center
   :width: 90%
   :alt: The Realtime Events report in Google Analytics

Or the **Behavior > Events** reports to see the dimensions you defined being 
tracked.

.. image:: images/analytics-behavior.*
   :align: center
   :width: 90%
   :alt: The Behavior Events report in Google Analytics

:ref:`Back to top <maintenance-web-analytics>`

.. _`Google Analytics`: https://analytics.google.com/analytics/web/#/
.. _`Set up custom dimension`: https://support.google.com/analytics/answer/2709829#set_up_custom_dimensions
.. _`Google Tag Manager`: https://www.google.com/tagmanager/
.. _`web property`: https://support.google.com/analytics/answer/1042508?hl=en
